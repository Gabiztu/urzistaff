<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urzistaff â€” Compact Checkout</title>
  <meta name="description" content="Complete your hiring process." />
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' rx='12' fill='%237F5AF0'/><text x='50%' y='54%' text-anchor='middle' font-size='34' font-family='Arial' fill='white'>UZ</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root{--primary:#7F5AF0;--accent-1:#00C6CF;--accent-2:#F04E8A;--light-bg:#FFFFFF;--light-surface:#F8FAFC;--light-elev:#FFFFFF;--light-text:#0F172A;--light-muted:#475569;--light-border:#E2E8F0;--dark-bg:#0B0A10;--dark-surface:#14131B;--dark-elev:#1C1B22;--dark-text:#E5E7EB;--dark-muted:#94A3B8;--dark-border:#2B2A33;--radius:14px;--pill:999px;--shadow:0 8px 32px rgba(0,0,0,.1);--ease-out:cubic-bezier(.22,1,.36,1);--space-4:clamp(12px,2.4vw,20px);--text-md:clamp(14px,1.4vw,16px);--text-lg:clamp(16px,1.6vw,20px)}
    html[data-theme="light"]{--bg:var(--light-bg);--surface:var(--light-surface);--elev:var(--light-elev);--text:var(--light-text);--muted:var(--light-muted);--border:var(--light-border)}
    html[data-theme="dark"]{--bg:var(--dark-bg);--surface:var(--dark-surface);--elev:var(--dark-elev);--text:var(--dark-text);--muted:var(--dark-muted);--border:var(--dark-border);--shadow:0 8px 40px rgba(0,0,0,0.4)}
    *,*::before,*::after{box-sizing:border-box}
    html{scroll-behavior:smooth; scrollbar-gutter: stable both-edges}
    body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);padding-bottom:0;min-height:100vh;display:flex;flex-direction:column}
    .container{max-width:960px;width:100%;margin:0 auto;padding:20px}
    h1,h2{font-family:"Space Grotesk",sans-serif}
    h1{font-size:clamp(1.8rem,4vw,2.2rem);margin:0 0 8px}
    h2{font-size:clamp(1.1rem,3vw,1.25rem);margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:10px}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .gradient-text{background:linear-gradient(120deg,var(--primary),var(--accent-1));-webkit-background-clip:text;background-clip:text;color:transparent}
    .checkout-layout{display:grid;grid-template-columns:1.2fr 1fr;grid-template-areas:"form summary";gap:32px;align-items:start}
    .payment-form{grid-area:form}
    .order-summary{grid-area:summary}
    @media(max-width:900px){.checkout-layout{grid-template-columns:1fr;grid-template-areas:"summary" "form"}body{align-items:flex-start}}
    .form-section{margin-bottom:24px}
    .form-group{margin-bottom:18px}
    .form-group label{display:block;font-weight:600;margin-bottom:6px;font-size:14px}
    .input{width:100%;padding:10px 14px;border-radius:8px;outline:none;border:1px solid var(--border);background:var(--elev);color:var(--text);transition:all .2s var(--ease-out);min-height:44px;font-size:var(--text-md)}
    .input::placeholder{color:color-mix(in oklab,var(--muted),#888 30%)}
    .input:focus,.input:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px color-mix(in oklab,var(--primary),transparent 70%)}
    .helper-text{color:var(--muted);font-size:13px;margin:6px 0 0}
    .error-text{color:var(--accent-2);font-size:13px;margin:6px 0 0}
    .form-row{display:flex;flex-wrap:wrap;gap:18px}
    .form-row>.form-group{flex:1;min-width:120px;margin-bottom:0}
    .order-summary{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;position:sticky;top:30px}
    .items-title{font-family:"Space Grotesk",sans-serif;font-weight:600;font-size:16px;margin:0 0 10px;color:var(--muted)}
    .items-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)}
    .item-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .item-row .name{font-weight:600}
    .item-row .price{font-weight:600}
    .price-details .price-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}
    .price-details .label{color:var(--muted)}
    .price-details .value{font-weight:500}
    .price-details .total{margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:var(--text-lg);font-weight:700}
    .price-details .total .value{color:var(--primary)}
    .btn-primary{width:100%;background:var(--primary);border:1px solid var(--primary);color:#fff;border-radius:10px;font-weight:600;padding:12px 24px;cursor:pointer;transition:transform .2s var(--ease-out);font-size:var(--text-md)}
    .btn-primary:hover{transform:scale(1.03)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-secondary{width:100%;text-align:center;display:inline-block;background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;font-weight:600;padding:12px 24px;cursor:pointer;transition:border-color .2s var(--ease-out), transform .2s var(--ease-out);font-size:var(--text-md);margin-bottom:10px}
    .btn-secondary:hover{border-color:#444;transform:translateY(-1px);text-decoration:none}
    .secure-info{text-align:center;margin-top:16px;font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:8px}
    .secure-info svg{width:14px;height:14px}
    /* Payment options */
    .pay-option{display:block}
    .pay-card{
      position:relative;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)),
        radial-gradient(120% 120% at 0% 0%, color-mix(in oklab, var(--primary), transparent 92%), transparent 60%);
      background-color: var(--elev);
      display:grid;grid-template-columns:48px 1fr 24px;gap:14px;align-items:center;
      transition:border-color .2s var(--ease-out), box-shadow .2s var(--ease-out), transform .2s var(--ease-out);
    }
    .pay-card:hover{border-color:#444;transform:translateY(-1px);box-shadow:var(--shadow)}
    label.pay-option:has(input:focus-visible) .pay-card{outline:2px solid color-mix(in oklab, var(--primary), white 20%);outline-offset:2px}
    label.pay-option:has(input:checked) .pay-card{border-color: color-mix(in oklab, var(--primary), #444 30%); box-shadow:0 0 0 2px color-mix(in oklab, var(--primary), transparent 70%) inset}
    .pay-icon{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;
      background: linear-gradient(135deg, color-mix(in oklab, var(--primary), #ffffff 8%), color-mix(in oklab, var(--primary), #000 0%));
      color:white;
    }
    .pay-title{font-weight:700; letter-spacing:.2px}
    .pay-desc{color:var(--muted);font-size:14px;margin-top:2px}
    .pay-meta{display:flex;flex-direction:column}
    .pay-check{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;border:2px solid var(--border);color:transparent;transition:all .2s var(--ease-out)}
    label.pay-option:has(input:checked) .pay-check{border-color:var(--primary);background:var(--primary);color:white}
    .legal-text{color:var(--muted);font-size:13px;margin-top:12px}
    .legal-text a{color:var(--text);text-decoration:underline}
    :focus-visible{outline:2px solid color-mix(in oklab,var(--primary),#fff 20%);outline-offset:2px}
    /* Header/Nav + Cart */
    .site-header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.5) blur(12px);background:color-mix(in oklab, var(--bg) 80%, transparent);border-bottom:1px solid var(--border);margin-bottom:24px}    
    .nav-container{display:flex;align-items:center;justify-content:space-between;padding:10px 20px}
    .nav-brand{display:flex;align-items:center;gap:10px;font-family:"Space Grotesk",sans-serif;font-weight:600;color:inherit;text-decoration:none}
    .nav-brand-logo{height:28px;width:auto;display:block}
    @media(min-width:768px){.nav-brand-logo{height:28px}}
    /* Header width container (initial site width) */
    .container-wide{max-width:1200px;margin:0 auto;padding:0 20px}
    .nav-links{display:none}
    .nav-brand-text{font-family:"Space Grotesk",sans-serif;font-weight:700;font-size:18px}
    @media(min-width:768px){.nav-links{display:flex;gap:24px;font-weight:500;color:var(--muted)}.nav-links a{color:inherit;text-decoration:none}.nav-links a.active{color:var(--text)}}
    .btn-cart{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:var(--pill);border:1px solid var(--border);background:var(--surface);color:var(--text);text-decoration:none}
    .btn-cart:hover{transform:translateY(-2px);box-shadow:var(--shadow);border-color:#444}
    .cart-icon{width:22px;height:22px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container-wide nav-container">
      <a href="/" class="nav-brand" aria-label="UrziStaff home">
        <span class="nav-brand-text">UrziStaff</span>
      </a>
      <nav class="nav-links">
        <a href="/">Home</a>
        <a href="/shop">Shop</a>
        <a href="/faq">FAQ</a>
        <a href="/support">Support</a>
      </nav>
      <a href="/cart" class="btn-cart" aria-label="Cart">
        <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.344 1.087-.849l1.858-6.443a.75.75 0 0 0-.7-1.028H5.613M15 21a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 0h-5.25"/></svg>
        <span id="cartCount">0</span>
      </a>
    </div>
  </header>
  <div class="container">
    <header style="text-align:left;margin-bottom:24px;">
      <h1><span class="gradient-text">Secure Checkout</span></h1>
      <p style="color:var(--muted);font-size:15px;margin:0;">You're one step away from boosting your productivity.</p>
    </header>

    <div class="checkout-layout">
      <main class="payment-form">
        <form id="checkoutForm" action="#" method="POST">
          <div class="form-section">
            <h2>Contact information</h2>
            <p class="helper-text">We'll use this Telegram username to send you order details and updates.</p>
            <div class="form-group" style="margin-top:10px;">
              <label for="telegram">Telegram Username</label>
              <input type="text" id="telegram" name="telegram" class="input" placeholder="@username" required pattern="^@[A-Za-z][A-Za-z0-9_]{4,31}$" title="Must start with @, begin with a letter, and be 5â€“32 characters using letters, numbers, or underscore">
              <p class="helper-text">You are currently checking out as a guest.</p>
              <p id="telegramError" class="error-text" style="display:none;">Please enter a valid Telegram username</p>
            </div>
          </div>
          <div class="form-section">
            <h2>Billing Information</h2>
            <div class="form-row" style="margin-bottom:12px">
              <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="fullName" class="input" placeholder="John M. Doe" required pattern="^[A-Za-z' -]+$" title="Only letters, spaces, hyphens (-), and apostrophes (') are allowed" inputmode="text" autocomplete="name">
                <p id="fullNameError" class="error-text" style="display:none;">Only letters, spaces, hyphens (-), and apostrophes (') are allowed</p>
              </div>
            </div>
            <div class="form-group">
              <label for="address">Street Address</label>
              <input type="text" id="address" name="address" class="input" placeholder="123 Main Street" required>
            </div>
            <div class="form-row" style="margin-bottom:12px">
              <div class="form-group" style="flex:1">
                <label for="country">Country</label>
                <select id="country" name="country" class="input" required>
                  <option value="" selected disabled>Select your country</option>
                  <option>United States</option>
                  <option>United Kingdom</option>
                  <option>Canada</option>
                  <option>Australia</option>
                  <option>New Zealand</option>
                  <option>Ireland</option>
                  <option>Germany</option>
                  <option>France</option>
                  <option>Italy</option>
                  <option>Spain</option>
                  <option>Portugal</option>
                  <option>Netherlands</option>
                  <option>Belgium</option>
                  <option>Switzerland</option>
                  <option>Austria</option>
                  <option>Sweden</option>
                  <option>Norway</option>
                  <option>Denmark</option>
                  <option>Finland</option>
                  <option>Poland</option>
                  <option>Czechia</option>
                  <option>Romania</option>
                  <option>Greece</option>
                  <option>Hungary</option>
                  <option>Bulgaria</option>
                  <option>Croatia</option>
                  <option>Serbia</option>
                  <option>Turkey</option>
                  <option>Ukraine</option>
                  <option>Russia</option>
                  <option>Brazil</option>
                  <option>Mexico</option>
                  <option>Argentina</option>
                  <option>Chile</option>
                  <option>Colombia</option>
                  <option>Peru</option>
                  <option>Philippines</option>
                  <option>India</option>
                  <option>Indonesia</option>
                  <option>Malaysia</option>
                  <option>Singapore</option>
                  <option>Thailand</option>
                  <option>Vietnam</option>
                  <option>Japan</option>
                  <option>South Korea</option>
                  <option>China</option>
                  <option>South Africa</option>
                  <option>Nigeria</option>
                  <option>Kenya</option>
                  <option>Egypt</option>
                  <option>United Arab Emirates</option>
                </select>
              </div>
              <div class="form-group" style="flex:1">
                <label for="region">State/County/Province</label>
                <input type="text" id="region" name="region" class="input" placeholder="State / County / Province">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" class="input" placeholder="New York" required pattern="^[A-Za-z ]+$" title="Only letters and spaces are allowed" inputmode="text" autocomplete="address-level2">
                <p id="cityError" class="error-text" style="display:none;">Only letters and spaces are allowed</p>
              </div>
              <div class="form-group">
                <label for="zip">ZIP Code</label>
                <input type="text" id="zip" name="zip" class="input" placeholder="10001" required>
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>Payment options</h2>
            <label class="pay-option" for="pay-now">
              <input type="radio" id="pay-now" name="payment" value="nowpayments" checked hidden>
              <div class="pay-card">
                <div class="pay-icon" aria-hidden="true">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Z" fill="currentColor"/>
                    <path d="M12 6a1 1 0 0 0-1 1v3H9a1 1 0 0 0 0 2h2v3a1 1 0 0 0 2 0v-3h2a1 1 0 0 0 0-2h-2V7a1 1 0 0 0-1-1Z" fill="currentColor"/>
                  </svg>
                </div>
                <div class="pay-meta">
                  <div class="pay-title">NOWPayments</div>
                  <div class="pay-desc">Pay with NOWPayments</div>
                </div>
                <div class="pay-check" aria-hidden="true">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
              </div>
            </label>
            <div class="form-group" style="margin-top:14px;">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none">
                <input type="checkbox" id="addNoteToggle" style="width:16px;height:16px"> Add a note to your order
              </label>
              <textarea id="orderNote" class="input" placeholder="Notes about your order." style="display:none;min-height:90px;resize:vertical"></textarea>
            </div>
            <p class="legal-text">By proceeding with your purchase you agree to our <a href="/terms" target="_blank" rel="noopener">Terms and Conditions</a> and <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a>.</p>
          </div>
        </form>
      </main>

      <aside class="order-summary">
        <h2>Order Summary</h2>
        <h3 class="items-title">Items (<span id="itemsCount">0</span>)</h3>
        <div id="itemsList" class="items-list"></div>
        <div class="price-details">
          <div class="price-row"><div class="label">Order Date</div><div id="orderDate" class="value">â€”</div></div>
          <div class="price-row"><div class="label">Subtotal</div><div id="subtotalVal" class="value">$0.00</div></div>
          <div class="price-row"><div class="label">Taxes & Fees</div><div id="feesVal" class="value">$0.00</div></div>
          <div class="price-row total"><div class="label">Total</div><div id="totalVal" class="value">$0.00</div></div>
        </div>
        <a href="/cart" id="backToCart" class="btn-secondary">Return to cart</a>
        <button id="confirmPay" class="btn-primary" type="submit" form="checkoutForm" style="margin-top:8px;">Confirm and Pay</button>
        <div class="secure-info">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a9 9 0 0 0-9 9 9 9 0 0 0 9 9 9 9 0 0 0 9-9A9 9 0 0 0 12 1zm0 16a7 7 0 0 1-7-7 7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7z"/><path d="M12 7a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0V8a1 1 0 0 0-1-1zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg>
          <span>Payments are secure and encrypted.</span>
        </div>
      </aside>
    </div>
  </div>
  <section class="theme-toggle-section" aria-label="Theme switcher" style="border-top:1px solid var(--border);background:var(--surface);margin-top:auto">
    <div class="container-wide" style="padding:20px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="font-weight:600; color: var(--muted)">Copyright by UrziStaff | All Rights Reserved by Gabriel Valentin Dragomir</div>
      <button id="toggleTheme" class="btn-secondary" type="button" style="width:auto">Switch to Dark</button>
    </div>
  </section>
  <script>
    (function(){
      const root = document.documentElement;
      try { const saved = localStorage.getItem('theme'); if (saved) root.setAttribute('data-theme', saved); } catch {}
      const btn = document.getElementById('toggleTheme');
      const updateBtn = () => { if(!btn) return; btn.textContent = (root.getAttribute('data-theme') === 'dark') ? 'Switch to Light' : 'Switch to Dark'; };
      btn?.addEventListener('click', () => {
        const cur = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        try { localStorage.setItem('theme', next); } catch {}
        updateBtn();
      });
      updateBtn();
    })();
    // Populate summary for multiple items from the cart (no mock data)
    (function(){
      const itemsEl = document.getElementById('itemsList');
      const countEl = document.getElementById('itemsCount');
      const subtotalEl = document.getElementById('subtotalVal');
      const feesEl = document.getElementById('feesVal');
      const totalEl = document.getElementById('totalVal');
      const confirmBtn = document.getElementById('confirmPay');
      const form = document.getElementById('checkoutForm');
      const UNIT_PRICE = 99;
      let cartHasItems = false;

      const loadCart = async () => {
        try {
          const res = await fetch('/api/cart', { cache: 'no-store' });
          const json = await res.json();
          return Array.isArray(json?.cart?.items) ? json.cart.items : [];
        } catch { return []; }
      };

      const format = (n) => `$${Number(n||0).toFixed(2)}`;

      const updateConfirm = () => {
        if (!confirmBtn) return;
        const validForm = form ? form.checkValidity() : true;
        confirmBtn.disabled = !(cartHasItems && validForm);
      };

      const render = async () => {
        const items = await loadCart();
        if (countEl) countEl.textContent = String(items.length);
        if (itemsEl) itemsEl.innerHTML = '';
        let subtotal = 0;
        items.forEach(it => {
          subtotal += UNIT_PRICE;
          const row = document.createElement('div');
          row.className = 'item-row';
          row.innerHTML = `<div class="name">${(it.name||'Listing')}</div><div class="price">${format(UNIT_PRICE)}</div>`;
          itemsEl.appendChild(row);
        });
        const fees = 0;
        const total = subtotal + fees;
        if (subtotalEl) subtotalEl.textContent = format(subtotal);
        if (feesEl) feesEl.textContent = format(fees);
        if (totalEl) totalEl.textContent = format(total);

        cartHasItems = items.length > 0;
        updateConfirm();
      };

      // Set current date
      const orderDateEl = document.getElementById('orderDate');
      if (orderDateEl) orderDateEl.textContent = new Date().toLocaleString();

      // Confirm -> navigate to success (placeholder; integrate real payment later)
      if (confirmBtn) {
        confirmBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (confirmBtn.disabled) return;
          if (form && !form.checkValidity()) {
            form.reportValidity();
            updateConfirm();
            return;
          }
          try {
            const payload = {};
            if (form) {
              payload.fullName = form.querySelector('#fullName')?.value || undefined;
              payload.telegram = form.querySelector('#telegram')?.value || undefined;
              const noteOn = form.querySelector('#addNoteToggle')?.checked;
              payload.note = noteOn ? (form.querySelector('#orderNote')?.value || '').trim() : undefined;
            }
            const res = await fetch('/api/payments/now', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json?.error || 'Payment creation failed');
            if (json?.invoice_url) {
              location.href = json.invoice_url;
            } else {
              throw new Error('Missing invoice URL');
            }
          } catch (err) {
            alert((err && err.message) || 'Failed to start payment. Please try again.');
          }
        });
      }

      // Re-evaluate button enabled state on form changes
      if (form) {
        const inputs = Array.from(form.querySelectorAll('input, select, textarea'));
        inputs.forEach(inp => {
          ['input','change','blur'].forEach(ev => inp.addEventListener(ev, updateConfirm));
        });
        // Full name: sanitize and validate
        const nameInput = form.querySelector('#fullName');
        const nameErr = document.getElementById('fullNameError');
        const sanitizeName = () => {
          if (!nameInput) return;
          const cleaned = nameInput.value.replace(/[^A-Za-z' -]+/g, '');
          if (cleaned !== nameInput.value) nameInput.value = cleaned;
        };
        const validateName = () => {
          if (!nameInput) return true;
          const v = nameInput.value.trim();
          if (v === '') { nameInput.setCustomValidity(''); if (nameErr) nameErr.style.display='none'; return true; }
          const ok = /^[A-Za-z' -]+$/.test(v);
          nameInput.setCustomValidity(ok ? '' : "Only letters, spaces, hyphens (-), and apostrophes (') are allowed");
          if (nameErr) nameErr.style.display = ok ? 'none' : '';
          return ok;
        };
        ['input','blur','change'].forEach(ev => nameInput?.addEventListener(ev, () => { sanitizeName(); validateName(); updateConfirm(); }));

        // City: sanitize and validate
        const cityInput = form.querySelector('#city');
        const cityErr = document.getElementById('cityError');
        const sanitizeCity = () => {
          if (!cityInput) return;
          const cleaned = cityInput.value.replace(/[^A-Za-z ]+/g, '');
          if (cleaned !== cityInput.value) cityInput.value = cleaned;
        };
        const validateCity = () => {
          if (!cityInput) return true;
          const v = cityInput.value.trim();
          if (v === '') { cityInput.setCustomValidity(''); if (cityErr) cityErr.style.display='none'; return true; }
          const ok = /^[A-Za-z ]+$/.test(v);
          cityInput.setCustomValidity(ok ? '' : 'Only letters and spaces are allowed');
          if (cityErr) cityErr.style.display = ok ? 'none' : '';
          return ok;
        };
        ['input','blur','change'].forEach(ev => cityInput?.addEventListener(ev, () => { sanitizeCity(); validateCity(); updateConfirm(); }));
        // Telegram inline validation
        const tgInput = form.querySelector('#telegram');
        const tgErr = document.getElementById('telegramError');
        const validateTelegram = () => {
          if (!tgInput) return true;
          const v = tgInput.value.trim();
          if (v === '') { // hide until user types; required will block on submit
            tgInput.setCustomValidity('');
            if (tgErr) tgErr.style.display = 'none';
            return true;
          }
          const ok = /^@[A-Za-z][A-Za-z0-9_]{4,31}$/.test(v);
          tgInput.setCustomValidity(ok ? '' : 'Username must start with @, begin with a letter, and be 5â€“32 chars (letters, numbers, underscore)');
          if (tgErr) tgErr.style.display = ok ? 'none' : '';
          return ok;
        };
        ['input','change','blur'].forEach(ev => tgInput?.addEventListener(ev, () => { validateTelegram(); updateConfirm(); }));
        // Note toggle show/hide
        const noteToggle = form.querySelector('#addNoteToggle');
        const noteArea = form.querySelector('#orderNote');
        if (noteToggle && noteArea) {
          const sync = () => { noteArea.style.display = noteToggle.checked ? '' : 'none'; };
          noteToggle.addEventListener('change', sync);
          sync();
        }
        // initial
        validateTelegram();
        sanitizeName(); validateName();
        sanitizeCity(); validateCity();
        updateConfirm();
      }

      render();
    })();

    // Update header cart count
    (function(){
      const countEl = document.getElementById('cartCount');
      const getLS = () => { try { return parseInt(localStorage.getItem('cart_count')||'0', 10) || 0; } catch { return 0; } };
      const setLS = (n) => { try { localStorage.setItem('cart_count', String(Math.max(0, n|0))); } catch {} };
      if (countEl) countEl.textContent = String(getLS());
      const updateCount = async () => {
        try {
          const res = await fetch('/api/cart', { cache: 'no-store' });
          const json = await res.json();
          const n = Array.isArray(json?.cart?.items) ? json.cart.items.length : 0;
          if (countEl) countEl.textContent = String(n);
          setLS(n);
        } catch { /* keep last-known value */ }
      };
      updateCount();
    })();
  </script>
</body>
</html>
